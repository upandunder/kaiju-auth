<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kaiju Auth Card</title>
  <style>
    body { margin: 0; background: #000; color: white; font-family: sans-serif; }
    #loading { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 4px; }
    canvas { display: block; }
  </style>
</head>
<body>
<div id="loading">Cargando tarjeta...</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/loaders/GLTFLoader.js';

// === 1. Escena básica ===
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0, 1, 2);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
scene.add(light);

// === 2. Cargar modelo GLB ===
const loader = new GLTFLoader();
const modelUrl = 'https://github.com/upandunder/kaiju-auth/raw/e627301318da589c0ed948f829a2fcea91d4d86f/tarjeta_sofubi_v3.glb';

loader.load(modelUrl, (gltf) => {
    const model = gltf.scene;
    scene.add(model);
    document.getElementById('loading').innerText = 'Tarjeta cargada';
}, undefined, (err) => {
    console.error(err);
    document.getElementById('loading').innerText = 'Error al cargar modelo';
});

// === 3. Función para añadir texto sobre la tarjeta ===
function addTextToCard(text, yOffset = 0.05) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 512;
    canvas.height = 128;
    ctx.fillStyle = 'white';
    ctx.font = '48px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(text, canvas.width / 2, canvas.height / 2);

    const texture = new THREE.CanvasTexture(canvas);
    const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });

    const plane = new THREE.Mesh(new THREE.PlaneGeometry(1, 0.25), material);
    plane.position.set(0, yOffset, 0.01);
    scene.add(plane);
}

// === 4. Obtener datos desde Google Sheet ===
async function loadKaijuData() {
    const params = new URLSearchParams(window.location.search);
    const kaijuId = params.get('id');
    if (!kaijuId) {
        document.getElementById('loading').innerText = '⚠️ No se especificó un ID';
        return;
    }

    try {
        const sheetUrl = 'https://tuusuario.github.io/kaiju-auth?id=KAI001';
        const res = await fetch(sheetUrl);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(','));

        const match = rows.find(r => r[0] === kaijuId);
        if (match) {
            const comprador = match[1];
            const fecha = match[2];
            const serie = match[3];

            addTextToCard(`Comprador: ${comprador}`, 0.1);
            addTextToCard(`Fecha: ${fecha}`, 0.05);
            addTextToCard(`Serie: ${serie}`, 0.0);

            document.getElementById('loading').innerText = '✅ Datos cargados';
        } else {
            document.getElementById('loading').innerText = `⚠️ ID ${kaijuId} no encontrado`;
        }
    } catch (err) {
        console.error(err);
        document.getElementById('loading').innerText = 'Error al cargar datos';
    }
}

loadKaijuData();

// === 5. Animación ===
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
